function t(){return t=Object.assign?Object.assign.bind():function(t){for(var e=1;e<arguments.length;e++){var r=arguments[e];for(var o in r)({}).hasOwnProperty.call(r,o)&&(t[o]=r[o])}return t},t.apply(null,arguments)}function e(t){if(t&&"object"==typeof t){if(Object.prototype.hasOwnProperty.call(t,"__isNodeRef")&&t.nodeId&&Array.isArray(t.path)){const e=t.path.join(".");return`{{node.${t.nodeId}.body${e?"."+e:""}}}`}if(Object.prototype.hasOwnProperty.call(t,"__isEventRef")&&Array.isArray(t.path))return`{{${t.path.join(".")}}}`;if(Array.isArray(t))return t.map(e);if(t.constructor===Object){const r={};for(const o of Object.keys(t))r[o]=e(t[o]);return r}}return t}function r(t,e=[]){return new Proxy({__isNodeRef:!0,nodeId:t,path:e},{get:(o,n)=>"string"!=typeof n||n in o?o[n]:r(t,[...e,n])})}let o=[];class n{constructor(t){this.id=void 0,this.slug=void 0,this.action=void 0,this.input=void 0,this.next_node=[],this._next_refs=[],this.id=String(n._counter++),this.slug=t.slug,this.action=t.action,this.input=e(t.input);const r=n.getCurrentForLoopContext();r&&r.addToForLoop(this)}next(t){return this.next_node.push(t.id),this._next_refs.push(t),t}get nextRefs(){return this._next_refs}get body(){return r(this.id,[])}static pushForLoopContext(t){o.push(t)}static popForLoopContext(){return o.pop()}static getCurrentForLoopContext(){return o.length>0?o[o.length-1]:null}static clearForLoopContext(){o=[]}}var s,i,a;n._counter=1,function(t){t.no_action="no_action",t.http_request="httprequest"}(s||(s={})),function(t){t.API_CALL="api_call",t.CRON="cron",t.EVENT="event"}(i||(i={})),function(t){t.ArrayIteration="array_iteration",t.FixedIteration="fixed_iteration"}(a||(a={}));class d extends n{constructor({operation:t,rules:e}){super({slug:"rule",action:s.no_action,input:{operation:t,rules:e}}),this._true_refs=[],this._false_refs=[],this.true_node=[],this.false_node=[]}trueNext(t){return this.true_node.push(t.id),this._true_refs.push(t),t}falseNext(t){return this.false_node.push(t.id),this._false_refs.push(t),t}get trueRefs(){return this._true_refs}get falseRefs(){return this._false_refs}}const u=[];class c extends n{constructor({action:t,array_item:e,fixed_iteration:r}){super({slug:"group",action:t,input:{array_item:e,fixed_iteration:r}}),this._entry_node_ref=null,this.entry_node=null,this._array_items=[],this._group_nodes=new Map,this._for_loop_nodes=[],this._is_in_for_loop=!1,this.array_item=[],u.push(this),this.array_item=new Proxy([],{get:(t,e)=>{if(e===Symbol.iterator){this.constructor.pushForLoopContext(this);const t=this;return function*(){yield new Proxy({},{get:(e,r)=>`{{node.${t.id}.array_item.${String(r)}}}`}),t.constructor.popForLoopContext()}}return t[e]}})}static getAllGroupNodes(){return[...u]}static clearRegistry(){u.length=0}setEntryNode(t){this._entry_node_ref=t,this.entry_node=t.id}get entryNode(){return this._entry_node_ref}next(t){return t.id.includes(".")?this:super.next(t)}startForLoopContext(){this._is_in_for_loop=!0,this._for_loop_nodes=[]}endForLoopContext(){this._is_in_for_loop=!1}trackForLoopNode(t){this._is_in_for_loop&&this._for_loop_nodes.push(t)}addForLoopNode(t){this._for_loop_nodes.push(t)}processForLoopNodes(){if(0===this._for_loop_nodes.length)return;const t=new Map;this._for_loop_nodes.forEach((e,r)=>{const o=e.id;this.processNodeInput(e);const s=String(n._counter++);this._group_nodes.set(s,e),e.id=s,t.set(o,s)}),this._for_loop_nodes.forEach(e=>{Array.isArray(e.next_node)&&(e.next_node=e.next_node.map(e=>t.get(e)||e))});const e=this._for_loop_nodes[0];e&&this.setEntryNode(e),this._for_loop_nodes=[]}addToForLoop(t){this._for_loop_nodes.push(t)}setArraySource(t){this._array_items=this.extractArrayFromSource(t),this.array_item=this._array_items}extractArrayFromSource(t){if(!t)return[];if(Array.isArray(t))return t;if(t&&"object"==typeof t&&"__isNodeRef"in t)return[];if(t&&"object"==typeof t&&"body"in t){const e=t.body;if(Array.isArray(e))return e;if(e&&"object"==typeof e&&"data"in e){const t=e.data;if(Array.isArray(t))return t}}if("string"==typeof t&&t.includes("{{"))return[];if(t&&"object"==typeof t&&"data"in t){const e=t.data;if(Array.isArray(e))return e}return[]}forEach(t){const e=[];return this._array_items.forEach((r,o)=>{t(r,o).forEach((t,n)=>{this.processNodeInput(t,r,o);const s=`${this.id}.${o}.${n}`;this._group_nodes.set(s,t),t.id=s,e.push(t)})}),e.length>0&&this.setEntryNode(e[0]),e}processNodeInput(t,e,r){t.input&&"object"==typeof t.input&&(t.input=this.keepTemplatesAsIs(t.input))}replaceArrayItemReferences(t,e,r){if(t&&"object"==typeof t){if("string"==typeof t)return this.replaceArrayItemInString(t,e,r);if(Array.isArray(t))return t.map(t=>this.replaceArrayItemReferences(t,e,r));if(t.constructor===Object){const o={};for(const n of Object.keys(t))o[n]=this.replaceArrayItemReferences(t[n],e,r);return o}}return t}keepTemplatesAsIs(t){if(t&&"object"==typeof t){if("string"==typeof t)return this.replaceArrayItemInString(t,null,0);if(Array.isArray(t))return t.map(t=>this.keepTemplatesAsIs(t));if(t.constructor===Object){const e={};for(const r of Object.keys(t))e[r]=this.keepTemplatesAsIs(t[r]);return e}}return t}replaceArrayItemInString(t,e,r){return t.replace(/\barray_item\.(\w+)\b/g,(t,e)=>`{{node.${this.id}.array_item.${e}}}`)}resolveStringTemplate(t){return t.replace(/\barray_item\.(\w+)\b/g,(t,e)=>`{{node.${this.id}.array_item.${e}}}`)}get currentArrayItems(){return this._array_items}get groupNodes(){return Array.from(this._group_nodes.values())}get arrayItems(){return this._array_items}}class p{constructor(){this.startNode=void 0}trigger(t){this.startNode=t}build(){if(!this.startNode)throw new Error("No start node set. Use trigger(startNode)");this.processAllGroupNodes();const e=[],r=new Set;!function t(o,n=[]){if(o){if(r.has(o.id))throw new Error(`Infinite loop detected in workflow at node id: ${o.id} (path: ${[...n,o.id].join(" -> ")})`);if(e.push(o),r.add(o.id),o instanceof c&&o.entryNode&&t(o.entryNode,[...n,o.id]),o instanceof d){for(const e of o.trueRefs)t(e,[...n,o.id]);for(const e of o.falseRefs)t(e,[...n,o.id])}for(const e of o.nextRefs||[])t(e,[...n,o.id])}}(this.startNode);const o=require("./nodes/GroupNode").GroupNode.getAllGroupNodes(),n=new Set(e.filter(t=>t instanceof c).map(t=>t.id));o.forEach(t=>{n.has(t.id)||e.push(t)});const s=new Set;return o.forEach(t=>{t.groupNodes&&t.groupNodes.forEach(t=>{s.add(t.id)})}),o.forEach(t=>{t.groupNodes&&t.groupNodes.forEach(t=>{e.some(e=>e.id===t.id)||e.push(t)})}),e.map(e=>{const r={id:e.id,slug:e.slug,action:e.action,input:e.input,next_node:e.next_node};return e instanceof d?t({},r,{true_nodes:e.true_node,false_nodes:e.false_node,next_node:[...e.true_node,...e.false_node]}):e instanceof c?t({},r,{entry_node:e.entry_node,group_nodes:e.groupNodes.map(t=>t.id),array_items:e.arrayItems}):r})}processAllGroupNodes(){require("./nodes/GroupNode").GroupNode.getAllGroupNodes().forEach(t=>{t.processForLoopNodes()})}printMermaid(){const t=this.build();let e="flowchart TD\n";const r=t.reduce((t,e)=>{let r=`${e.slug} (${e.id})`;if("entry_node"in e&&e.entry_node&&(r=`Group: ${e.slug} (${e.id})`),e.id.includes(".")){const t=e.id.split(".");t.length>=3&&(r=`${e.slug} [${t[1]}] (${e.id})`)}return t[e.id]=r,t},{});for(const o of t){let n="";"entry_node"in o&&o.entry_node?n=t.some(t=>"group_nodes"in t&&Array.isArray(t.group_nodes)&&t.group_nodes.includes(o.id))?":::nestedGroupNode":":::groupNode":o.id.includes(".")&&(n=":::groupChildNode"),e+=`  ${o.id}["${r[o.id]}"]${n}\n`}for(const r of t){if(Array.isArray(r.next_node))for(const o of r.next_node)t.some(t=>t.id===o)&&(e+=`  ${r.id} --\x3e ${o}\n`);if("truth_node"in r&&Array.isArray(r.truth_node))for(const o of r.truth_node)t.some(t=>t.id===o)&&(e+=`  ${r.id} --|truth|--\x3e ${o}\n`);if("falsy_node"in r&&Array.isArray(r.falsy_node))for(const o of r.falsy_node)t.some(t=>t.id===o)&&(e+=`  ${r.id} --|falsy|--\x3e ${o}\n`);"entry_node"in r&&r.entry_node&&t.some(t=>t.id===r.entry_node)&&(e+=`  ${r.id} -.-> ${r.entry_node}\n`)}for(const r of t)if("group_nodes"in r&&Array.isArray(r.group_nodes))for(const o of r.group_nodes){const n=t.find(t=>t.id===o);n&&"entry_node"in n&&(e+=`  ${r.id} -.->|nested| ${o}\n`)}return e+="\n  classDef groupNode fill:#e8f5e8,stroke:#2e7d32,stroke-width:2px\n",e+="  classDef nestedGroupNode fill:#fff3e0,stroke:#f57c00,stroke-width:2px\n",e+="  classDef groupChildNode fill:#f3e5f5,stroke:#7b1fa2,stroke-width:1px\n",e}}function _(t=[]){const e={__isEventRef:!0,path:["event",...t]};return new Proxy(e,{get:(e,r)=>"string"!=typeof r||r in e?e[r]:_([...t,r])})}class f extends n{constructor({trigger_type:t,event_id:e,cron_expression:r,api_call_payload:o}){super({slug:"start",action:s.no_action,input:{trigger_type:t,event_id:e,cron_expression:r,api_call_payload:o}})}get event(){return _([])}}class l extends n{constructor({url:t,method:e,body:r,query_params:o,headers:n}){super({slug:"httpinternal",action:s.http_request,input:{url:t,method:e,body:r,query_params:o,headers:n}})}}class h extends n{constructor({data:t}){super({slug:"response",action:s.no_action,input:{data:t}})}}class y extends n{constructor({parameters:t,function:e}){const r=e.toString().replace(/^\(params\)\s*=>\s*/,"function yourFunction(params) {\n  ");super({slug:"code_executor",action:s.no_action,input:{parameters:t,function:r}}),this._codeFunction=void 0,this._codeFunction=e}get codeFunction(){return this._codeFunction}}var g,m;!function(t){t.eq="eq",t.neq="neq",t.gt="gt",t.gte="gte",t.lt="lt",t.lte="lte",t.in="in",t.nin="nin",t.contains="contains",t.not_contains="not_contains"}(g||(g={})),function(t){t.AND="and",t.OR="or"}(m||(m={}));class x extends n{constructor({application_slug:t,action:e,input:r}){super({slug:t,action:e,input:r})}}export{s as Actions,y as CodeExecutorNode,x as ExternalApp,a as GroupActions,c as GroupNode,l as HttpNode,m as Operation,g as Operators,h as ResponseNode,d as RuleNode,f as StartNode,i as StartNodeTrigger,p as Workflow};
